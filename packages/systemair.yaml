# This file includes all the entitites for tracking sensor data for Systemair heat exchanger (VTX).
#
# Works for the Save Connect 2.0 with Systemair VSR 300 and the following firmware:
# Model: VSR 300
# Main board
# SW: 1.22.0
# IAM
# SW: 1.3.0
#
# The MODBUS-registers and logic is taken from:
# A. https://github.com/cmragnar/HomeAssistant-VSR300-Modbus
# B. And from the javascript on the Save Connect interface reached locally.
# C. https://shop.systemair.com/upload/assets/SAVE_MODBUS_VARIABLE_LIST_20210301_REV36.PDF?a94f4fe0

# Updates made for Core updates and breaking changes:
# --------------------------------------------------------
# N/A for the moment.

# To be able to easily change the IP for the Save Connect device.
input_text:
  systemair_save_connect_device_ip:
    name: "Domain- or IP-address of the Systemair Save Connect device"
    icon: mdi:hvac

# To be able to choose different types and configurations.
input_select:
  systemair_chosen_unit_type:
    name: Type of Systemair device
    options:
      - Systemair VSR 300
    initial: Systemair VSR 300
    icon: mdi:hvac

template:
  - sensor:
      # This is the configuration array that holds all data to be able to interact with Save Connect.
      # Links to 'systemair_chosen_unit_type'.
      # The configuration array holds all valid registers for the Systemair sensors/functions.
      # All register-addresses seems to be one lower than value in MODBUS variable list.
      - name: Systemair configuration
        unique_id: systemair_configuration
        state: >
          {{ "Systemair configuration" }}
        attributes:
          configuration: >
            {% set json_array = { "Systemair VSR 300": {
                                   "REG_USERMODE_MANUAL_AIRFLOW_LEVEL": { "register": "1130", "desc": "Fan speed level for mode Manual. Applies to both the supply and the extract air fans." },
                                   "REG_USERMODE_MODE": { "register": "1160", "desc": "Active user mode." },
                                   "REG_FAN_MANUAL_STOP_ALLOWED": { "register": "1352", "desc": "Allow manual fan stop (also as selection for user modes and Week schedule)." },
                                   "REG_TC_SP": { "register": "2000", "desc": "Current temperature setpoint." },
                                   "REG_HEAT_EXCHANGER_TYPE": { "register": "2132", "desc": "Heat exchanger type (register name not official)." },
                                   "REG_ECO_MODE_ON_OFF": { "register": "2504", "desc": "ECO mode configuration status." },
                                   "REG_HEATER_TYPE": { "register": "3001", "desc": "Heater type (register name not official)." },
                                   "REG_PLATE_EXCHANGER_BYPASS_LOCATION": { "register": "3002", "desc": "Plate exchange bypass location (register name not official)." },
                                   "REG_TEMP_UNIT": { "register": "9002", "desc": "Temperature unit (register name not official)." },
                                   "REG_SENSOR_FPT": { "register": "12100", "desc": "Frost protection temperature sensor." },
                                   "REG_SENSOR_OAT": { "register": "12101", "desc": "Outdoor air temperature sensor value." },
                                   "REG_SENSOR_SAT": { "register": "12102", "desc": "Supply air temperature sensor value." },
                                   "REG_SENSOR_RAT": { "register": "12103", "desc": "Room air temperature sensor value." },
                                   "REG_SENSOR_EAT": { "register": "12104", "desc": "Extract air temperature sensor value." },
                                   "REG_SENSOR_OHT": { "register": "12107", "desc": "Overheat temperature sensor value." },
                                   "REG_SENSOR_RHS_PDM": { "register": "12135", "desc": "In-built extract air relative humidity sensor value." },
                                   "REG_SENSOR_RPM_SAF": { "register": "12400", "desc": "Supply Fan (SAF) RPM indication." },
                                   "REG_SENSOR_RPM_EAF": { "register": "12401", "desc": "Extract Air Fan (EAF) RPM indication." },
                                   "REG_SENSOR_PDM_EAT_VALUE": { "register": "12543", "desc": "In-built extract air temperature sensor value." },
                                   "REG_HEATER_ACTUATOR": { "register": "13020", "desc": "Heater actuator (register name not official)." },
                                   "REG_HEAT_EXCHANGER_ACTUATOR": { "register": "13021", "desc": "Heat exchanger actuator (register name not official)." },
                                   "REG_OUTPUT_SAF": { "register": "14000", "desc": "Supply Air Fan (SAF) output, percentage." },
                                   "REG_OUTPUT_EAF": { "register": "14001", "desc": "Extract Air Fan (EAF) output, percentage." }
                                  }
                                } %}
            {{ json_array }}

      # This is the configuration array that holds all data to be able to interact with Save Connect.
      # Links to 'systemair_chosen_unit_type'.
      # The configuration array holds all valid registers for the Systemair sensors/functions.
      # All register-addresses seems to be one lower than value in MODBUS variable list.
      - name: Systemair Save connect response
        unique_id: systemair_save_connect_response
        state: >
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set result = device_type %}
          {% endif %}
          {{ result }}
        attributes:
          response: >
            {% set response1 = states('sensor.systemair_save_connect_response_1_part') %}
            {% set response2 = states('sensor.systemair_save_connect_response_2_part') %}
            {% set inputs_valid = true %}
            {% set result = none %}
            {% if (response1 == 'unknown' or response1 == 'unavailable' or response1 == 'none') %}
            {%   set inputs_valid = false %}
            {% endif %}
            {% if (inputs_valid == true) %}
            {%   if (response2 == 'unknown' or response2 == 'unavailable' or response2 == 'none') %}
            {%     set result = response1 %}
            {%   else %}
            {%     set result = response1 + response2 %}
            {%   endif %}
            {% endif %}
            {{ result }}

      # We want to gather information about the temperature unit.
      # Modbus register in configuration: REG_TEMP_UNIT
      # Logic:
      # 0 - Celcius
      # 1- Fahrenheit
      - name: Systemair read temperature unit
        unique_id: systemair_read_temperature_unit
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_TEMP_UNIT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the temperature unit, to string.
      # Modbus register in configuration: REG_TEMP_UNIT
      # Logic:
      # 0 - Celcius
      # 1- Fahrenheit
      - name: Systemair read temperature unit str
        unique_id: systemair_read_temperature_unit_str
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_TEMP_UNIT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "°C" %}
          {%   elif (value == 1) %}
          {%     set result = "°F" %}
          {%   endif %}
          {% endif %}
          {{ result }}

      # We want to gather the current temperature setpoint in celcius.
      # Modbus register in configuration: REG_TC_SP
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read current temperature setpoint celcius
        unique_id: systemair_read_current_temperature_setpoint_celcius
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_TC_SP"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = result %}
          {%   elif (temp_unit == 1) %}
          {%     set result = ((result - 32) * (5/9)) %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather the current temperature setpoint in fahrenheit.
      # Modbus register in configuration: REG_TC_SP
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read current temperature setpoint fahrenheit
        unique_id: systemair_read_current_temperature_setpoint_fahrenheit
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°F"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_TC_SP"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = ((result * (9/5)) + 32) %}
          {%   elif (temp_unit == 1) %}
          {%     set result = result %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the active user mode.
      # Modbus register in configuration: REG_USERMODE_MODE
      # Logic:
      # 0: Auto
      # 1: Manual
      # 2: Crowded
      # 3: Refresh
      # 4: Fireplace
      # 5: Away
      # 6: Holiday
      # 7: Cooker Hood
      # 8: Vacuum cleaner
      # 9: Configurable DI 1
      # 10: Configurable DI 2
      # 11: Configurable D
      - name: Systemair read active user mode
        unique_id: systemair_read_active_user_mode
        state_class: measurement
        icon: mdi:cog
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_USERMODE_MODE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the active user mode, to string.
      # Modbus register in configuration: REG_USERMODE_MODE
      # Logic:
      # 0: Auto
      # 1: Manual
      # 2: Crowded
      # 3: Refresh
      # 4: Fireplace
      # 5: Away
      # 6: Holiday
      # 7: Cooker Hood
      # 8: Vacuum cleaner
      # 9: Configurable DI 1
      # 10: Configurable DI 2
      # 11: Configurable D
      - name: Systemair read active user mode str
        unique_id: systemair_read_active_user_mode_str
        icon: mdi:cog
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_USERMODE_MODE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "Auto" %}
          {%   elif (value == 1) %}
          {%     set result = "Manual" %}
          {%   elif (value == 2) %}
          {%     set result = "Crowded" %}
          {%   elif (value == 3) %}
          {%     set result = "Refresh" %}
          {%   elif (value == 4) %}
          {%     set result = "Fireplace" %}
          {%   elif (value == 5) %}
          {%     set result = "Away" %}
          {%   elif (value == 6) %}
          {%     set result = "Holiday" %}
          {%   elif (value == 7) %}
          {%     set result = "Cooker Hood" %}
          {%   elif (value == 8) %}
          {%     set result = "Vacuum cleaner" %}
          {%   elif (value == 9) %}
          {%     set result = "Configurable DI 1" %}
          {%   elif (value == 10) %}
          {%     set result = "Configurable DI 2" %}
          {%   elif (value == 11) %}
          {%     set result = "Configurable D" %}
          {%   endif %}
          {% endif %}
          {{ result }}

      # We want to gather the fan speed level for mode manual.
      # Modbus register in configuration: REG_USERMODE_MANUAL_AIRFLOW_LEVEL
      # Logic:
      # 0: Off (only allowed if REG_FAN_MANUAL_STOP_ALLOWED register value is 1)
      # 1: Not used
      # 2: Low
      # 3: Normal
      # 4: High
      - name: Systemair read usermode manual airflow level
        unique_id: systemair_read_usermode_manual_airflow_level
        state_class: measurement
        icon: mdi:fan
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_USERMODE_MANUAL_AIRFLOW_LEVEL"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather the fan speed level for mode manual, to string.
      # Modbus register in configuration: REG_USERMODE_MANUAL_AIRFLOW_LEVEL
      # Logic:
      # 0: Off (only allowed if REG_FAN_MANUAL_STOP_ALLOWED register value is 1)
      # 1: Not used
      # 2: Low
      # 3: Normal
      # 4: High
      - name: Systemair read usermode manual airflow level str
        unique_id: systemair_read_usermode_manual_airflow_level_str
        icon: mdi:fan
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_USERMODE_MANUAL_AIRFLOW_LEVEL"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "Off" %}
          {%   elif (value == 1) %}
          {%     set result = "Not used" %}
          {%   elif (value == 2) %}
          {%     set result = "Low" %}
          {%   elif (value == 3) %}
          {%     set result = "Normal" %}
          {%   elif (value == 4) %}
          {%     set result = "High" %}
          {%   endif %}
          {% endif %}
          {{ result }}

      # We want to gather information about the Supply Air Fan (SAF) RPM indication.
      # Modbus register in configuration: REG_SENSOR_RPM_SAF
      - name: Systemair read SAF RPM indication
        unique_id: systemair_read_saf_rpm_indication
        unit_of_measurement: "rpm"
        state_class: measurement
        icon: mdi:fan
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_RPM_SAF"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the Supply Air Fan (SAF) percentage.
      # Modbus register in configuration: REG_OUTPUT_SAF
      # Min value 16.
      - name: Systemair read SAF percentage
        unique_id: systemair_read_saf_percentage
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:fan
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_OUTPUT_SAF"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the Extract Air Fan (EAF) RPM indication.
      # Modbus register in configuration: REG_SENSOR_RPM_EAF
      - name: Systemair read EAF RPM indication
        unique_id: systemair_read_eaf_rpm_indication
        unit_of_measurement: "rpm"
        state_class: measurement
        icon: mdi:fan
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_RPM_EAF"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the Extract Air Fan (EAF) percentage.
      # Modbus register in configuration: REG_OUTPUT_EAF
      # Min value 16.
      - name: Systemair read EAF percentage
        unique_id: systemair_read_eaf_percentage
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:fan
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_OUTPUT_EAF"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather the current outdoor air temperature, in celcius.
      # Modbus register in configuration: REG_SENSOR_OAT
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read outdoor air temperature celcius
        unique_id: systemair_read_outdoor_air_temperature_celcius
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_OAT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = result %}
          {%   elif (temp_unit == 1) %}
          {%     set result = ((result - 32) * (5/9)) %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather the current outdoor air temperature, in fahrenheit.
      # Modbus register in configuration: REG_SENSOR_OAT
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read outdoor air temperature fahrenheit
        unique_id: systemair_read_outdoor_air_temperature_fahrenheit
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°F"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_OAT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = ((result * (9/5)) + 32) %}
          {%   elif (temp_unit == 1) %}
          {%     set result = result %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather the current supply air temperature, in celcius.
      # Modbus register in configuration: REG_SENSOR_SAT
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read supply air temperature celcius
        unique_id: systemair_read_supply_air_temperature_celcius
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_SAT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = result %}
          {%   elif (temp_unit == 1) %}
          {%     set result = ((result - 32) * (5/9)) %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather the current supply air temperature, in fahrenheit.
      # Modbus register in configuration: REG_SENSOR_SAT
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read supply air temperature fahrenheit
        unique_id: systemair_read_supply_air_temperature_fahrenheit
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°F"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_SAT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = ((result * (9/5)) + 32) %}
          {%   elif (temp_unit == 1) %}
          {%     set result = result %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather the current extract air temperature, in celcius.
      # Modbus register in configuration: REG_SENSOR_PDM_EAT_VALUE
      # On my device REG_SENSOR_EAT is empty, but REG_SENSOR_PDM_EAT_VALUE has right value.
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read extract air temperature celcius
        unique_id: systemair_read_extract_air_temperature_celcius
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_PDM_EAT_VALUE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = result %}
          {%   elif (temp_unit == 1) %}
          {%     set result = ((result - 32) * (5/9)) %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather the current extract air temperature, in fahrenheit.
      # Modbus register in configuration: REG_SENSOR_PDM_EAT_VALUE
      # On my device REG_SENSOR_EAT is empty, but REG_SENSOR_PDM_EAT_VALUE has right value.
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read extract air temperature fahrenheit
        unique_id: systemair_read_extract_air_temperature_fahrenheit
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°F"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_PDM_EAT_VALUE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = ((result * (9/5)) + 32) %}
          {%   elif (temp_unit == 1) %}
          {%     set result = result %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather the current overheat temperature, in celcius.
      # Modbus register in configuration: REG_SENSOR_OHT
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read overheat temperature celcius
        unique_id: systemair_read_overheat_temperature_celcius
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_OHT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = result %}
          {%   elif (temp_unit == 1) %}
          {%     set result = ((result - 32) * (5/9)) %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result  }}

      # We want to gather the current overheat temperature, in fahrenheit.
      # Modbus register in configuration: REG_SENSOR_OHT
      # Takes into account the temperature unit of the unit.
      # Logic:
      # If the temperature sensor reading is higher than 60000: Temperature = (REG_SENSOR_* - 65536) / 10
      # If temperature sensor reading is lower than 60000: Temperature = REG_SENSOR_* / 10
      - name: Systemair read overheat temperature fahrenheit
        unique_id: systemair_read_overheat_temperature_fahrenheit
        #  device_class: "temperature" # Removed 20250130 since by adding device_class HA automatically converts according to the unit-system set for the installation.
        unit_of_measurement: "°F"
        state_class: measurement
        icon: mdi:thermometer
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set temp_unit = states('sensor.systemair_read_temperature_unit') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (temp_unit == 'unknown' or temp_unit == 'unavailable' or temp_unit == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_OHT"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   set temp_unit = int(temp_unit) %}
          {%   if (value > 60000) %}
          {%     set result = (value - 65536) / 10  %}
          {%   else %}
          {%     set result = value / 10  %}
          {%   endif %}
          {%   if (temp_unit == 0) %}
          {%     set result = ((result * (9/5)) + 32) %}
          {%   elif (temp_unit == 1) %}
          {%     set result = result %}
          {%   endif %}
          {%   set result = result | round(1) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the extract air relative humidity sensor value.
      # Modbus register in configuration: REG_SENSOR_RHS_PDM
      - name: Systemair read EAF relative humidity
        unique_id: systemair_read_eaf_relative_humidity
        device_class: "humidity"
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:water-percent
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_SENSOR_RHS_PDM"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result | float(none) }}

      # We want to gather the heat exchanger type.
      # Modbus register in configuration: REG_HEAT_EXCHANGER_TYPE
      # Logic:
      # 0: Rotating
      # 1: Plate
      - name: Systemair read heat exchanger type
        unique_id: systemair_read_heat_exchanger_type
        state_class: measurement
        icon: mdi:hvac
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEAT_EXCHANGER_TYPE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather the heat exchanger type, to string.
      # Modbus register in configuration: REG_HEAT_EXCHANGER_TYPE
      # Logic:
      # 0: Rotating
      # 1: Plate
      - name: Systemair read heat exchanger type str
        unique_id: systemair_read_heat_exchanger_type_str
        icon: mdi:hvac
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEAT_EXCHANGER_TYPE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "Rotating" %}
          {%   elif (value == 1) %}
          {%     set result = "Plate" %}
          {%   endif %}
          {% endif %}
          {{ result }}

      # We want to gather the heat exchanger actuator.
      # Modbus register in configuration: REG_HEAT_EXCHANGER_ACTUATOR
      # Logic:
      # 0: 0-10V
      # 1: 2-10V
      # 2: 10-0V
      # 3: 10-2V
      - name: Systemair read heat exchanger actuator
        unique_id: systemair_read_heat_exchanger_actuator
        state_class: measurement
        icon: mdi:current-dc
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEAT_EXCHANGER_ACTUATOR"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather the heat exchanger actuator, to string
      # Modbus register in configuration: REG_HEAT_EXCHANGER_ACTUATOR
      # Logic:
      # 0: 0-10V
      # 1: 2-10V
      # 2: 10-0V
      # 3: 10-2V
      - name: Systemair read heat exchanger actuator str
        unique_id: systemair_read_heat_exchanger_actuator_str
        icon: mdi:current-dc
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEAT_EXCHANGER_ACTUATOR"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "0-10V" %}
          {%   elif (value == 1) %}
          {%     set result = "2-10V" %}
          {%   elif (value == 2) %}
          {%     set result = "10-0V" %}
          {%   elif (value == 3) %}
          {%     set result = "10-2V" %}
          {%   endif %}
          {% endif %}
          {{ result }}

      # We want to gather the plate exchange bypass location.
      # Modbus register in configuration: REG_PLATE_EXCHANGER_BYPASS_LOCATION
      # Logic:
      # 0: Supply
      # 1: Extract
      - name: Systemair read plate exchanger bypass location
        unique_id: systemair_read_plate_exchanger_bypass_location
        state_class: measurement
        icon: mdi:swap-horizontal
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_PLATE_EXCHANGER_BYPASS_LOCATION"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather the plate exchange bypass location, to string.
      # Modbus register in configuration: REG_PLATE_EXCHANGER_BYPASS_LOCATION
      # Logic:
      # 0: Supply
      # 1: Extract
      - name: Systemair read plate exchanger bypass location str
        unique_id: systemair_read_plate_exchanger_bypass_location_str
        icon: mdi:swap-horizontal
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_PLATE_EXCHANGER_BYPASS_LOCATION"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "Supply" %}
          {%   elif (value == 1) %}
          {%     set result = "Extract" %}
          {%   endif %}
          {% endif %}
          {{ result }}

      # We want to gather the heater type.
      # Modbus register in configuration: REG_HEATER_TYPE
      # Logic:
      # 0: None
      # 1: Electrical
      # 2: Water
      # 3: Change-over
      - name: Systemair read heater type
        unique_id: systemair_read_heater_type
        state_class: measurement
        icon: mdi:heat-wave
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEATER_TYPE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather the heater type, to string.
      # Modbus register in configuration: REG_HEATER_TYPE
      # Logic:
      # 0: None
      # 1: Electrical
      # 2: Water
      # 3: Change-over
      - name: Systemair read heater type str
        unique_id: systemair_read_heater_type_str
        icon: mdi:heat-wave
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEATER_TYPE"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "None" %}
          {%   elif (value == 1) %}
          {%     set result = "Electrical" %}
          {%   elif (value == 2) %}
          {%     set result = "Water" %}
          {%   elif (value == 3) %}
          {%     set result = "Change-over" %}
          {%   endif %}
          {% endif %}
          {{ result }}

      # We want to gather the heater type.
      # Modbus register in configuration: REG_HEATER_ACTUATOR
      # Logic:
      # 0: 0-10V
      # 1: 2-10V
      # 2: 10-0V
      # 3: 10-2V
      - name: Systemair read heater actuator
        unique_id: systemair_read_heater_actuator
        state_class: measurement
        icon: mdi:current-dc
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEATER_ACTUATOR"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather the heater type, to string.
      # Modbus register in configuration: REG_HEATER_ACTUATOR
      # Logic:
      # 0: 0-10V
      # 1: 2-10V
      # 2: 10-0V
      # 3: 10-2V
      - name: Systemair read heater actuator str
        unique_id: systemair_read_heater_actuator_str
        icon: mdi:current-dc
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_HEATER_ACTUATOR"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = "0-10V" %}
          {%   elif (value == 1) %}
          {%     set result = "2-10V" %}
          {%   elif (value == 2) %}
          {%     set result = "10-0V" %}
          {%   elif (value == 3) %}
          {%     set result = "10-2V" %}
          {%   endif %}
          {% endif %}
          {{ result }}

  - binary_sensor:
      # We want to gather the fan speed level for mode: manual.
      # Modbus register in configuration: REG_FAN_MANUAL_STOP_ALLOWED
      - name: Systemair read fan manual stop allowed
        unique_id: systemair_read_fan_manual_stop_allowed
        icon: mdi:fan-off
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_FAN_MANUAL_STOP_ALLOWED"].register | string %}
          {%   set value = value_json[register] %}
          {%   set result = int(value) %}
          {% endif %}
          {{ result }}

      # We want to gather information about the ECO mode configuration status.
      # Modbus register in configuration: REG_ECO_MODE_ON_OFF
      - name: Systemair read ECO mode configuration status
        unique_id: systemair_read_eco_mode_configuration_status
        icon: mdi:sprout
        state: >
          {% set value_json = state_attr('sensor.systemair_save_connect_response', 'response') %}
          {% set device_type = states('input_select.systemair_chosen_unit_type') %}
          {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value_json == 'unknown' or value_json == 'unavailable' or value_json == 'none' or value_json == '' or value_json == {} or value_json == '{}None') %}
          {%   set inputs_valid = false %}
          {% elif (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
          {%   set inputs_valid = false %}
          {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set register = json_array[device_type]["REG_ECO_MODE_ON_OFF"].register | string %}
          {%   set value = value_json[register] %}
          {%   set value = int(value) %}
          {%   if (value == 0) %}
          {%     set result = 0 %}
          {%   elif (value == 1) %}
          {%     set result = 1 %}
          {%   endif %}
          {% endif %}
          {{ result }}

rest:
  # To not overflow the Save Connect device, we gather all data we need with one call.
  # Here we have a constraint of 255 characters for sensors, and I could not use attributes as I do not want to hardcode registers in the rest-sensor.
  #   On top of that we also got an warning at startup in the logs for temperature sensors: has device class 'temperature', state class 'measurement' unit '°C' and suggested precision 'None' thus indicating it has a numeric value; however, it has the non-numeric value: 'Unknown' (<class 'str'
  #     I tried all sorts of yaml-trickery but could not get the warning to not appear in the logs.
  #       Therefore I reverted back, and created two sensors of 255 characters each, that is thereafter added to a sensor attribute from the sensors (i.e. no 255 limit).
  #         Template sensors can thereafter gather data from the sensor-attributes.
  #     I still get the following warning for the rest sensor: Template variable warning: 'None' has no attribute 'Systemair VSR 300'
  #       I have not yet figured out yaml-wizardry to remove this.
  # Scanned every 60 second (not 30 as default), as the Save Connect device seems sensitive to too many requests.
  # http://192.168.4.118/mread?{%221130%22:1,%221160%22:1,%221352%22:1,%222000%22:1,%222132%22:1,%222504%22:1,%229002%22:1,%2212100%22:1,%2212101%22:1,%2212102%22:1,%2212103%22:1,%2212104%22:1,%2212107%22:1,%2212135%22:1,%2212400%22:1,%2212401%22:1,%2212543%22:1,%2213021%22:1,%2214000%22:1,%2214001%22:1}
  - scan_interval: 30
    timeout: 28
    resource_template: >
      {% set device_type = states('input_select.systemair_chosen_unit_type') %}
      {% set device_ip = states('input_text.systemair_save_connect_device_ip') %}
      {% set json_array = state_attr('sensor.systemair_configuration', 'configuration') %}
      {% set inputs_valid = true %}
      {% set result = none %}
      {% if (device_type == 'unknown' or device_type == 'unavailable' or device_type == 'none') %}
      {%     set inputs_valid = false %}
      {% elif (device_ip == 'unknown' or device_ip == 'unavailable' or device_ip == 'none') %}
      {%     set inputs_valid = false %}
      {% elif (json_array == 'unknown' or json_array == 'unavailable' or json_array == 'none' or json_array == '' or json_array == {} or json_array == '{}None') %}
      {%     set inputs_valid = false %}
      {% endif %}
      {% if (inputs_valid == true) %}
      {%   set entries_valid = true %}
      {%   set entries = json_array[device_type] %}
      {%   if (entries == 'unknown' or entries == 'unavailable' or entries == 'none') %}
      {%     set entries_valid = false %}
      {%   endif %}
      {%   if (entries_valid == true) %}
      {%     set ns = namespace(url = "http://" + device_ip + "/mread?") %}
      {%     for entry in entries %}
      {%       set register_valid = true %}
      {%       set register = json_array[device_type][entry].register | string %}
      {%       if (register == 'unknown' or register == 'unavailable' or register == 'none') %}
      {%         set register_valid = false %}
      {%       endif %}
      {%       if (register_valid == true) %}
      {%         if (loop.first) %}
      {%           set ns.url = ns.url + "{" %}
      {%         endif %}
      {%         set ns.url = ns.url + "%22" + register + "%22:1" %}
      {%         if (loop.last) %}
      {%           set ns.url = ns.url + "}" %}
      {%         else %}
      {%           set ns.url = ns.url + "," %}
      {%         endif %}
      {%       endif %}
      {%     endfor %}
      {%     set result = ns.url %}
      {%   endif %}
      {% endif %}
      {{ result }}
    sensor:
      # We want to gather characters 0-254 in the response as state.
      # A sensor can maximum have 255 characters.
      - name: Systemair Save connect response 1 part
        unique_id: systemair_save_connect_response_1_part
        value_template: >
          {% set value = value_json %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value == 'unknown' or value == 'unavailable' or value == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set result = value | replace("'", '"') %}
          {%   set length = result | count %}
          {%   if (length > 255) %}
          {%     set result = result[0:255] %}
          {%   endif %}
          {% endif %}
          {{ result }}
      # We want to gather characters 255-509 in the response as state.
      # A sensor can maximum have 255 characters.
      - name: Systemair Save connect response 2 part
        unique_id: systemair_save_connect_response_2_part
        value_template: >
          {% set value = value_json %}
          {% set inputs_valid = true %}
          {% set result = none %}
          {% if (value == 'unknown' or value == 'unavailable' or value == 'none') %}
          {%   set inputs_valid = false %}
          {% endif %}
          {% if (inputs_valid == true) %}
          {%   set result = value | replace("'", '"') %}
          {%   set length = result | count %}
          {%   if (length > 255) %}
          {%     set result = result[255:511] %}
          {%   else %}
          {%     set result = none %}
          {%   endif %}
          {% endif %}
          {{ result }}
